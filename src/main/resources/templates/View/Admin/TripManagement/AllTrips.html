<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Danh sách chuyến xe</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.all.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>

    <style>
        body {
            background-color: #f8f9fa;
            color: #343a40;
            font-family: 'Roboto', sans-serif;
        }

        h1 {
            text-align: center;
            margin-bottom: 20px;
        }

        .table th {
            background-color: #e9ecef;
        }

        .status.scheduled {
            color: green;
        }

        .status.completed {
            color: blue;
        }

        .status.canceled {
            color: red;
        }

        .filter-container {
            margin-bottom: 20px;
        }

        th,
        td {
            text-align: center;
            /* Căn giữa theo chiều ngang */
            vertical-align: middle;
            /* Căn giữa theo chiều dọc */
        }
    </style>
</head>

<body>
<div class="container mt-5">
    <div class="bg-white px-4 md:px-36 rounded-lg w-full">
        <div class="flex w-full h-20">
            <div class="flex w-1/2 h-full justify-start items-center">
                <div class="font-bold text-3xl capitalize text-gray-700 italic">danh sách chuyến xe</div>
            </div>
            <div class="flex w-1/2 h-full justify-end items-center">
                <button class="bg-green-500 hover:bg-green-600 text-white font-semibold py-2 px-4 rounded-lg" onclick="openAddTripModal()">
                    Thêm
                </button>
            </div>
        </div>

        <!-- Modal thêm chuyến xe -->
        <div id="addTripModal" class="fixed z-10 inset-0 overflow-y-auto hidden" tabindex="-1"
             aria-labelledby="modalLabel" aria-hidden="true">
            <div class="flex items-center justify-center min-h-screen">
                <div class="bg-white shadow-lg rounded-lg w-full max-w-2xl p-6">
                    <div class="flex justify-between items-center border-b pb-2 mb-4">
                        <h5 class="text-lg font-bold" id="modalLabel">Thêm Chuyến Xe</h5>
                        <button type="button" class="text-gray-500 hover:text-gray-700"
                                onclick="document.getElementById('addTripModal').classList.add('hidden')">
                            &times;
                        </button>
                    </div>
                    <div class="modal-body">
                        <form id="addTripForm" method="POST" action="/admin/tripManagement/create">
                            <input type="hidden" id="tripId" name="tripId">

                            <div class="grid grid-cols-2 gap-4 mb-3">
                                <div class="px-3">
                                    <label for="departureLocation" class="block font-medium">Thành phố khởi hành</label>
                                    <select class="block w-full border border-gray-300 rounded px-2 py-1"
                                            id="departureLocation" name="departureLocation" required>
                                        <option value="">Chọn điểm khởi hành</option>
                                    </select>
                                </div>
                                <div class="px-3">
                                    <label for="arrivalLocation" class="block font-medium">Thành phố đến</label>
                                    <select class="block w-full border border-gray-300 rounded px-2 py-1"
                                            id="arrivalLocation" name="arrivalLocation" required>
                                        <option value="">Chọn điểm đến</option>
                                    </select>
                                </div>
                            </div>

                            <div class="grid gap-4 mb-3 px-3">
                                <div id="routeIdContainer" class="bg-red-100 border border-red-400 rounded text-red-700">
                                    <p id="routeIdMessage" class="m-0"></p>
                                    <input type="text" class="form-control" id="routeId" name="route.RouteId" required>
                                </div>
                            </div>

                            <div class="grid grid-cols-2 gap-4 mb-3">
                                <div class="px-3">
                                    <label for="busId" class="block font-medium">Mã số xe</label>
                                    <input type="number" class="block w-full border border-gray-300 rounded px-2 py-1"
                                           id="busId" name="bus.Id" required>
                                </div>
                                <div class="px-3">
                                    <label for="driverId" class="block font-medium">Mã tài xế</label>
                                    <input type="number" class="block w-full border border-gray-300 rounded px-2 py-1"
                                           id="driverId" name="driver.driverId" required>
                                </div>
                            </div>

                            <div class="grid gap-4 mb-3">
                                <div class="px-3">
                                    <label for="departureStation" class="block font-medium">Điểm khởi hành</label>
                                    <input type="text" class="block w-full border border-gray-300 rounded px-2 py-1"
                                           id="departureStation" name="departureStation" required>
                                </div>
                            </div>
                            <div class="grid gap-4 mb-3">
                                <div class="px-3">
                                    <label for="arrivalStation" class="block font-medium">Điểm đến</label>
                                    <input type="text" class="block w-full border border-gray-300 rounded px-2 py-1"
                                           id="arrivalStation" name="arrivalStation" required>
                                </div>
                            </div>

                            <div class="grid gap-4 mb-3">
                                <div class="px-3">
                                    <label for="departureTime" class="block font-medium">Thời gian khởi hành</label>
                                    <input type="datetime-local"
                                           class="block w-full border border-gray-300 rounded px-2 py-1"
                                           id="departureTime" name="departureTime" required>
                                </div>
                            </div>

                            <div class="grid grid-cols-2 gap-4 mb-3">
                                <div class="px-3">
                                    <label for="price" class="block font-medium">Giá vé</label>
                                    <input type="number" class="block w-full border border-gray-300 rounded px-2 py-1"
                                           id="price" name="price" required>
                                </div>
                                <div class="px-3">
                                    <label for="availableSeats" class="block font-medium">Chỗ ngồi còn trống</label>
                                    <input type="number" class="block w-full border border-gray-300 rounded px-2 py-1"
                                           id="availableSeats" name="availableSeats" required>
                                </div>
                            </div>

                            <input type="hidden" id="tripStatus" name="tripStatus" value="SCHEDULED">

                            <div class="flex justify-end">
                                <button type="button"
                                        class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded"
                                        onclick="submitAddTripForm()">
                                    Lưu Chuyến Xe
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
        <!-- Modal cập nhật chuyến xe -->
        <div id="updateTripModal" class="fixed z-10 inset-0 overflow-y-auto hidden" tabindex="-1"
             aria-labelledby="modalLabelUpdate" aria-hidden="true">
            <div class="flex items-center justify-center min-h-screen">
                <div class="bg-white shadow-lg rounded-lg w-full max-w-2xl p-6">
                    <div class="flex justify-between items-center border-b pb-2 mb-4">
                        <h5 class="text-lg font-bold" id="modalLabelUpdate">Cập Nhật Chuyến Xe</h5>
                        <button type="button" class="text-gray-500 hover:text-gray-700"
                                onclick="document.getElementById('updateTripModal').classList.add('hidden')">
                            &times;
                        </button>
                    </div>
                    <div class="modal-body">
                        <form id="updateTripForm" method="POST" action="/admin/tripManagement/update">
                            <input type="hidden" id="edittripId" name="tripId"> <!-- Trường ẩn cho tripId -->

                            <div class="grid grid-cols-2 gap-4 mb-3">
                                <div class="px-3">
                                    <label for="editdepartureLocation" class="block font-medium">Thành phố khởi hành</label>
                                    <select class="block w-full border border-gray-300 rounded px-2 py-1" id="editdepartureLocation" name="departureLocation">
                                        <option value="">Chọn điểm khởi hành</option>
                                    </select>
                                </div>
                                <div class="px-3">
                                    <label for="editarrivalLocation" class="block font-medium">Thành phố đến</label>
                                    <select class="block w-full border border-gray-300 rounded px-2 py-1" id="editarrivalLocation" name="arrivalLocation">
                                        <option value="">Chọn điểm đến</option>
                                    </select>
                                </div>
                            </div>

                            <div class="grid gap-4 mb-3 px-3">
                                <div id="editrouteIdContainer" class="bg-red-100 border border-red-400 rounded px-3 text-red-700">
                                    <p id="editrouteIdMessage" class="m-0"></p>
                                    <p class="block w-full border border-gray-300 rounded px-2 py-1" id="peditrouteId"></p>
                                    <input type="hidden" id="editrouteId" name="route.RouteId">
                                </div>
                            </div>

                            <div class="grid grid-cols-2 gap-4 mb-3">
                                <div class="px-3">
                                    <label for="editbusId" class="block font-medium">Mã số xe</label>
                                    <input type="text" class="block w-full border border-gray-300 rounded px-2 py-1" id="editbusId" name="bus.Id" required>
                                </div>
                                <div class="px-3">
                                    <label for="editdriverId" class="block font-medium">Mã tài xế</label>
                                    <input type="number" class="block w-full border border-gray-300 rounded px-2 py-1" id="editdriverId" name="driver.driverId" required>
                                </div>
                            </div>

                            <div class="grid gap-4 mb-3">
                                <div class="px-3">
                                    <label for="editdepartureStation" class="block font-medium">Điểm khởi hành</label>
                                    <input type="text" class="block w-full border border-gray-300 rounded px-2 py-1" id="editdepartureStation" name="departureStation" required>
                                </div>
                            </div>
                            <div class="grid gap-4 mb-3">
                                <div class="px-3">
                                    <label for="editarrivalStation" class="block font-medium">Điểm đến</label>
                                    <input type="text" class="block w-full border border-gray-300 rounded px-2 py-1" id="editarrivalStation" name="arrivalStation" required>
                                </div>
                            </div>

                            <div class="grid grid-cols-2 gap-4 mb-3">
                                <div class="px-3">
                                    <label for="editdepartureTime" class="block font-medium">Thời gian khởi hành</label>
                                    <input type="datetime-local" class="block w-full border border-gray-300 rounded px-2 py-1" id="editdepartureTime" name="departureTime" required>
                                </div>
                                <div class="px-3">
                                    <label for="editarrivalTime" class="block font-medium">Thời gian kết thúc</label>
                                    <input type="datetime-local" class="block w-full border border-gray-300 rounded px-2 py-1" id="editarrivalTime" name="arrivalTime">
                                </div>
                            </div>

                            <div class="grid grid-cols-2 gap-4 mb-3">
                                <div class="px-3">
                                    <label for="editprice" class="block font-medium">Giá vé</label>
                                    <input type="number" class="block w-full border border-gray-300 rounded px-2 py-1" id="editprice" name="price" required>
                                </div>
                                <div class="px-3">
                                    <label for="editavailableSeats" class="block font-medium">Chỗ ngồi còn trống</label>
                                    <input type="number" class="block w-full border border-gray-300 rounded px-2 py-1" id="editavailableSeats" name="availableSeats" required>
                                </div>
                            </div>

                            <div class="grid mb-3 px-3">
                                <label for="edittripStatus" class="block font-medium">Trạng thái chuyến xe</label>
                                <select class="block w-full border border-gray-300 rounded px-2 py-1" id="edittripStatus" name="tripStatus" required>
                                    <option value="SCHEDULED">SCHEDULED</option>
                                    <option value="COMPLETED">COMPLETED</option>
                                    <option value="CANCELLED">CANCELLED</option>
                                </select>
                            </div>

                            <div class="flex justify-end">
                                <button type="submit"
                                        class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded">
                                    Cập Nhật Chuyến Xe
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
        <!-- Bảng chuyến xe -->
        <!-- Lặp qua danh sách chuyến xe -->
        <div class="bg-white rounded-lg shadow-md mb-4 trip-container" th:each="trip : ${listTrips.listTrips}">
            <div class="px-4 py-2 rounded-t-lg flex flex-row justify-between items-center" style="background-color: #5b21b6">
                <div class="flex flex-col md:flex-row">
                    <div class="flex mx-2 items-center">
                        <p class="text-xs md:text-sm text-gray-500 px-1">Mã chuyến xe: </p>
                        <p class="text-xs md:text-sm text-gray-500 trip-id" th:text="${trip.id}"></p>
                    </div>
                    <div class="flex mx-2 items-center">
                        <p class="text-xs md:text-sm text-gray-500 px-1">Mã tuyến: </p>
                        <p class="text-xs md:text-sm text-gray-500 route-id" th:text="${trip.route.routeId}"></p>
                        <p class="text-xs md:text-sm text-gray-500 bus-id hidden" th:text="${trip.bus.id}"></p>
                        <p class="text-xs md:text-sm text-gray-500 driver-id hidden" th:text="${trip.driver.id}"></p>
                        <p class="text-xs md:text-sm text-gray-500 status hidden" th:text="${trip.tripStatus}"></p>
                    </div>
                </div>
                <div class="flex mt-2 md:mt-0">
                    <button class="bg-yellow-500 hover:bg-yellow-600 text-white font-bold py-1 px-2 rounded w-full md:w-auto mx-1 text-xs md:text-sm" onclick="editTrip(this)">
                        Chỉnh sửa
                    </button>
                    <button onclick="confirmDeleteTrip(this)" class="bg-red-500 hover:bg-red-600 text-white font-bold py-1 px-2 rounded w-full md:w-auto text-xs md:text-sm">
                        Xóa
                    </button>
                </div>
            </div>
            <div class="bg-white rounded-b-lg shadow-md p-2 mb-3">
                <div class="flex flex-row justify-between items-center bg-white px-2 md:px-8 py-2">
                    <div class="text-center w-full md:w-1/4 mb-2 md:mb-0">
                        <p class="text-2xl md:text-4xl font-bold departure-location" th:text="${trip.route.departureLocation}"></p>
                        <p class="text-lg md:text-xl font-medium text-gray-500 mt-2 departure-location">
                            <span th:text="${trip.departureStation}"></span>
                        </p>
                    </div>
                    <div class="text-center w-full md:w-1/4 mb-2 md:mb-0">
                        <p class="text-gray-700 departureTime hidden" th:text="${trip.departureTime}"></p>
                        <p class="text-gray-700 arrivalTime hidden" th:text="${trip.arrivalTime}"></p>
                        <div class="flex justify-center">
                            <p class="text-gray-700 departureDate w-fit px-1 text-xs md:text-sm" id="departureDate"></p>
                            <p class="text-gray-700 departureHour w-fit px-1 text-xs md:text-sm" id="departureHour"></p>
                        </div>
                        <div class="flex items-center justify-center space-x-2">
                            <span class="text-yellow-500"><i class="fa-solid fa-bus"></i></span>
                            <p class="text-gray-600 text-xs md:text-sm">
                                <span th:text="${trip.price}"></span> VND
                            </p>
                            <span class="text-gray-500 text-xs md:text-sm">|</span>
                            <p class="text-gray-600 availableSeats text-xs md:text-sm">
                                <span th:text="${trip.availableSeats}"></span> Chỗ trống
                                <i class="fa-solid fa-angle-down px-2"></i>
                            </p>
                        </div>
                    </div>
                    <div class="text-center w-full md:w-1/4 mb-2 md:mb-0">
                        <p class="text-2xl md:text-4xl font-bold arrival-location" th:text="${trip.route.arrivalLocation}"></p>
                        <p class="text-lg md:text-xl font-medium text-gray-500 mt-2 arrival-location">
                            <span th:text="${trip.arrivalStation}"></span>
                        </p>
                    </div>
                    <div class="flex flex-col items-center w-full md:w-1/4 mb-2 md:mb-0">
                        <img src="https://cdn.pixabay.com/photo/2020/08/05/13/28/eco-5465481_1280.png" alt="Eco class" class="w-8 mx-auto mb-1">
                        <p class="text-xs md:text-sm text-gray-500" th:text="${trip.bus.licensePlate}">51B-051.78</p>
                        <p class="text-lg md:text-xl text-red-600 font-bold" th:text="${trip.driver.name}">Phan Văn Tài</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!--tách ngày-->
<script>
    document.addEventListener('DOMContentLoaded', function () {
        // Lấy tất cả các phần tử departureTime
        const departureTimeElements = document.querySelectorAll('.departureTime');

        departureTimeElements.forEach((departureTimeElement) => {
            const departureTime = departureTimeElement.textContent.trim();

            console.log("Departure Time from HTML:", departureTime); // Debug

            if (departureTime) {
                // Tách giá trị thành ngày và giờ
                const [date, time] = departureTime.split('T');

                // Chia tách phần ngày thành năm, tháng, ngày
                const [year, month, day] = date.split('-');
                // Định dạng lại thành dd/mm/yyyy
                const formattedDate = `${day}/${month}/${year}`;

                // Tìm phần tử chứa ngày và giờ tương ứng trong thẻ `trip-container`
                const tripContainer = departureTimeElement.closest('.trip-container');
                const departureDateElement = tripContainer.querySelector('#departureDate'); // Tìm departureDate
                const departureHourElement = tripContainer.querySelector('#departureHour'); // Tìm departureHour

                // Hiển thị ngày và giờ trong các phần tử riêng biệt
                departureDateElement.textContent = `${formattedDate}`;
                departureHourElement.textContent = ` ${time}`;
            } else {
                console.warn('departureTime không có giá trị.'); // Cảnh báo nếu không có giá trị
            }
        });
    });

</script>
<!-- Truyền biến & kiểm tra thêm -->
<script>
    function submitAddTripForm() {
        const routeId = document.getElementById('routeId').value;
        const busId = document.getElementById('busId').value;
        const driverId = document.getElementById('driverId').value;
        const departureStation = document.getElementById('departureStation').value;
        const arrivalStation = document.getElementById('arrivalStation').value;
        const departureTime = document.getElementById('departureTime').value;
        const price = document.getElementById('price').value;
        const availableSeats = document.getElementById('availableSeats').value;

        if (!routeId) {
            // Hiển thị thông báo SweetAlert nếu không có tuyến đường
            Swal.fire({
                icon: 'warning',
                title: 'Chưa chọn tuyến đường!',
                text: 'Vui lòng chọn tuyến đường trước khi tạo chuyến xe.',
                confirmButtonText: 'OK'
            });
        } else if (!busId || !driverId || !departureStation || !arrivalStation || !departureTime || !price || !availableSeats) {
            Swal.fire({
                icon: 'warning',
                title: 'Thông tin không đầy đủ!',
                text: 'Vui lòng điền tất cả các trường trước khi tạo chuyến xe.',
                confirmButtonText: 'OK'
            });
        } else {
            // Nếu đã có routeId, hiển thị thông báo thành công trước
            Swal.fire({
                icon: 'success',
                title: 'Tạo chuyến xe thành công!',
                text: 'Chuyến xe đã được tạo thành công.',
                confirmButtonText: 'OK'
            }).then((result) => {
                // Kiểm tra xem người dùng đã bấm OK chưa
                if (result.isConfirmed) {
                    // Sau khi bấm OK, tiến hành gửi dữ liệu form
                    document.getElementById('addTripForm').submit();
                }
            });
        }
    }
</script>
<!--truyền biến & kiểm tra sửa-->
<script>
    function editTrip(button) {
        // Tìm thẻ chứa dữ liệu của card
        const tripContainer = button.closest('.trip-container');

        // Lấy các dữ liệu từ các phần tử con
        const tripId = tripContainer.querySelector('.trip-id').textContent.trim();
        const routeId = tripContainer.querySelector('.route-id').textContent.trim();
        const busId = tripContainer.querySelector('.bus-id').textContent.trim();
        const driverId = tripContainer.querySelector('.driver-id').textContent.trim();
        const status = tripContainer.querySelector('.status').textContent.trim();
        const departureLocation = tripContainer.querySelector('.departure-location').textContent.trim();
        const departureStation = tripContainer.querySelector('.departure-location span').textContent.trim();
        const arrivalLocation = tripContainer.querySelector('.arrival-location').textContent.trim();
        const arrivalStation = tripContainer.querySelector('.arrival-location span').textContent.trim();
        const departureTime = tripContainer.querySelector('.departureTime').textContent.trim();
        const arrivalTime = tripContainer.querySelector('.arrivalTime').textContent.trim();
        const price = tripContainer.querySelector('.text-gray-600 span').textContent.trim();
        const availableSeats = tripContainer.querySelector('.availableSeats span').textContent.trim();

        console.log("Giá trị status là:", status); // Kiểm tra giá trị status

        // Hiện modal
        document.getElementById('updateTripModal').classList.remove('hidden');

        // Gán giá trị vào các trường input
        document.getElementById('edittripId').value = tripId;
        document.getElementById('editrouteId').value = routeId;
        document.getElementById('peditrouteId').textContent = routeId;
        document.getElementById('editbusId').value = busId;
        document.getElementById('editdriverId').value = driverId;
        document.getElementById('editdepartureStation').value = departureStation;
        document.getElementById('editarrivalStation').value = arrivalStation;
        document.getElementById('editdepartureTime').value = departureTime;
        document.getElementById('editarrivalTime').value = arrivalTime;
        document.getElementById('editprice').value = price;
        document.getElementById('editavailableSeats').value = availableSeats;

        // Gán giá trị cho select status
        document.getElementById('edittripStatus').value = status;
    }
</script>

<!-- Bootstrap JS and dependencies -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script type="text/javascript" th:src="@{/js/trip.js}"></script>
</body>

</html>