<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{View/Layout/AdminLayout.html}">
<head>
    <meta charset="UTF-8">
    <title>Quản lý Xe</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script>
        // function deleteAccount(button) {
        //     if (confirm('Bạn có chắc chắn muốn xóa tài khoản này?')) {
        //         var id = button.dataset.name;
        //         console.log(`/api/accounts/${id}`);
        //         fetch(`/api/accounts/${id}`, {
        //             method: 'DELETE'
        //         })
        //             .then(response => {
        //                 if (response.ok) {
        //                     alert('Xóa tài khoản thành công!');
        //                     window.location.reload();
        //                 } else {
        //                     alert('Xóa tài khoản thất bại!');
        //                 }
        //             })
        //             .catch(error => {
        //                 console.error('Error:', error);
        //                 alert('Xóa tài khoản thất bại!');
        //             });
        //     }
        // }

        function updateAccountStatus(select) {
            const accountId = select.dataset.accountid;
            const newStatus = select.value;

            fetch(`/api/accounts/${accountId}/status`, {
                method: 'PATCH',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ accountStatus: newStatus })
            })
                .then(response => {
                    if (response.ok) {
                        alert('Cập nhật trạng thái thành công!');
                        // You might want to reload the page or update the table row directly here
                        window.location.reload();
                    } else {
                        alert('Cập nhật trạng thái thất bại!');
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('Cập nhật trạng thái thất bại!');
                });
        }

        function updateAccountRole(select) {
            const accountId = select.dataset.accountid;
            const newRole = select.value;

            fetch(`/api/accounts/${accountId}/role`, {
                method: 'PATCH',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ role: newRole })
            })
                .then(response => {
                    if (response.ok) {
                        alert('Cập nhật vai trò thành công!');
                        // You might want to reload the page or update the table row directly here
                        window.location.reload();
                    } else {
                        alert('Cập nhật vai trò thất bại!');
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('Cập nhật vai trò thất bại!');
                });
        }

        function startSpeechRecognition() {
            const keywordInput = document.getElementById('keyword');
            const searchForm = document.getElementById('searchForm'); // Get the form element
            const recognition = new (window.SpeechRecognition || window.webkitSpeechRecognition)();

            recognition.onresult = function(event) {
                const result = event.results[0][0].transcript;
                keywordInput.value = result;
                searchForm.submit(); // Submit the form immediately
            };

            recognition.start();
        }

        //Optional function to perform search with enter key
        function handleKeyPress(event) {
            if (event.keyCode === 13) {
                document.getElementById('searchForm').submit();
            }
        }
    </script>
</head>
<body class="bg-gray-100">
<div layout:fragment="content">
    <div class="container mx-auto p-4">
        <h1 class="text-2xl font-bold mb-4">Quản Lý Tài Khoản</h1>

        <!-- Search -->
        <form id="searchForm" action="/admin/accounts/search" method="get">  <!-- Added id to the form -->
            <div class="mb-4 flex items-center">
                <input type="text" name="keyword" id="keyword" placeholder="Tìm kiếm theo tên, email, mật khẩu"
                       class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline mr-2" onkeydown="handleKeyPress(event)">
                <button type="submit" class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded mt-2 mr-2">Tìm kiếm</button>
                <i class="fas fa-microphone cursor-pointer" onclick="startSpeechRecognition()"></i>
            </div>
        </form>

        <!-- Thông báo thành công hoặc lỗi -->
        <div>
            <div th:if="${successMessage}"
                 class="bg-green-100 border border-green-400 text-green-700 px-4 py-3 rounded mb-4" role="alert">
                <span th:text="${successMessage}"></span>
            </div>
            <div th:if="${errorMessage}" class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded mb-4"
                 role="alert">
                <span th:text="${errorMessage}"></span>
            </div>
        </div>

        <div class="flex justify-end mb-4">
            <a href="/admin/accounts/add" class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded">
                Thêm Tài Khoản
            </a>
        </div>

        <table class="min-w-full bg-white">
            <thead>
            <tr>
                <th class="py-2 px-4 border-b">ID Tài Khoản</th>
                <th class="py-2 px-4 border-b">Tên</th>
                <th class="py-2 px-4 border-b">Email</th>
                <th class="py-2 px-4 border-b">Mật Khẩu</th>
                <th class="py-2 px-4 border-b">Vai trò</th>
                <th class="py-2 px-4 border-b">Trạng Thái</th>
            </tr>
            </thead>
            <tbody>
            <tr th:each="account : ${accounts}" class="text-center">
                <td class="py-2 px-4 border-b" th:text="${account.id}">1</td>
                <td class="py-2 px-4 border-b" th:text="${account.username}">Nguyen Van A</td>
                <td class="py-2 px-4 border-b" th:text="${account.email}">abc123@gmail.com</td>
                <td class="py-2 px-4 border-b" th:text="${account.password}">*************</td>
                <td class="py-2 px-4 border-b">
                    <select th:data-accountid="${account.id}" onchange="updateAccountRole(this)"
                            th:classappend="${account.role == T(com.example.ticketbooker.Util.Enum.Role).CUSTOMER} ? 'bg-blue-200 text-blue-700 border-blue-400' :
                                           (${account.role == T(com.example.ticketbooker.Util.Enum.Role).STAFF} ? 'bg-yellow-200 text-yellow-700 border-yellow-400' :
                                           'bg-purple-200 text-purple-700 border-purple-400')"
                            class="shadow appearance-none border rounded w-full py-2 px-3 leading-tight focus:outline-none focus:shadow-outline text-center">
                        <option value="CUSTOMER" th:selected="${account.role == T(com.example.ticketbooker.Util.Enum.Role).CUSTOMER}">CUSTOMER</option>
                        <option value="STAFF" th:selected="${account.role == T(com.example.ticketbooker.Util.Enum.Role).STAFF}">STAFF</option>
                        <option value="MANAGER" th:selected="${account.role == T(com.example.ticketbooker.Util.Enum.Role).MANAGER}">MANAGER</option>
                    </select>
                </td>
                <td class="py-2 px-4 border-b">
                    <select th:data-accountid="${account.id}" onchange="updateAccountStatus(this)"
                            th:classappend="${account.accountStatus == T(com.example.ticketbooker.Util.Enum.AccountStatus).ACTIVE} ? 'bg-green-200 text-green-700 border-green-400' : 'bg-red-200 text-red-700 border-red-400'"
                            class="shadow appearance-none border rounded w-full py-2 px-3 leading-tight focus:outline-none focus:shadow-outline text-center">
                        <option value="ACTIVE" th:selected="${account.accountStatus == T(com.example.ticketbooker.Util.Enum.AccountStatus).ACTIVE}">ACTIVE</option>
                        <option value="INACTIVE" th:selected="${account.accountStatus == T(com.example.ticketbooker.Util.Enum.AccountStatus).INACTIVE}">INACTIVE</option>
                    </select>
                </td>
                <td class="py-2 px-4 border-b">
                    <a th:href="@{/admin/accounts/{id}(id=${account.id})}"
                       class="bg-yellow-500 hover:bg-yellow-700 text-white font-bold py-1 px-5 rounded mr-2">Sửa</a>
<!--                    <button th:data-name="${account.id}" onclick="deleteAccount(this)"-->
<!--                            class="bg-red-500 hover:bg-red-700 text-white font-bold py-1 px-2 rounded">Xóa-->
<!--                    </button>-->
                </td>
            </tr>
            </tbody>
        </table>
        <div class="mt-4 flex justify-center">
            <ul class="flex">
                <li th:each="i : ${#numbers.sequence(0, totalPages - 1)}" class="mx-1 px-3 py-2 rounded-lg"
                    th:classappend="${currentPage == i} ? 'bg-blue-500 text-white' : 'bg-gray-200'">
                    <a th:href="@{/admin/accounts(page=${i}, size=10)}" th:text="${i + 1}"></a>
                </li>
            </ul>
        </div>
    </div>
</div>
</body>
</html>
