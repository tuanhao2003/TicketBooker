<!DOCTYPE html>
<html lang="vi" xmlns:th="http://thymeleaf.org" xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{View/Layout/UserLayout.html}">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reset Password</title>
</head>
<body class="bg-purple-50">
<div layout:fragment="content">
    <div class="bg-white shadow-lg rounded-lg p-8 max-w-md w-full mx-auto my-10">
        <h1 class="text-center text-2xl font-bold text-violet-500 mb-6">Reset Password Request</h1>
        <div class="space-y-4">
            <div>
                <label for="username" class="block text-gray-700 font-medium">Username</label>
                <input type="text" id="username"
                       class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-violet-500 focus:border-violet-500"
                       required>
            </div>
            <div>
                <label for="password" class="block text-gray-700 font-medium">New Password</label>
                <input type="password" id="password"
                       class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-violet-500 focus:border-violet-500"
                       required>
            </div>
            <div>
                <label for="confirmPassword" class="block text-gray-700 font-medium">Confirm New Password</label>
                <input type="password" id="confirmPassword"
                       class="mt-1 block w-full border-gray-300 rounded-md shadow-sm focus:ring-violet-500 focus:border-violet-500"
                       required>
                <p id="error" class="text-red-500 text-sm mt-1 hidden">Passwords do not match.</p>
            </div>
            <div>
                <button type="submit" id="submitBtn"
                        class="w-full bg-violet-500 text-white py-2 px-4 rounded-lg shadow hover:bg-violet-600 disabled:opacity-50"
                        disabled>
                    Change Password
                </button>
            </div>
        </div>
    </div>

</div>
</body>
<script layout:fragment="script">
    (function () {
        document.addEventListener("DOMContentLoaded", function () {
            const username = document.getElementById("username");
            const password = document.getElementById("password");
            const confirmPassword = document.getElementById("confirmPassword");
            const submitBtn = document.getElementById("submitBtn");
            const error = document.getElementById("error");

            username.addEventListener("input", validateForm);
            password.addEventListener("input", validateForm);
            confirmPassword.addEventListener("input", validateForm);
            sendEmailConfirm();

            function validateForm() {
                const isUsernameFilled = username.value.trim() !== "";
                const isPasswordFilled = password.value.trim() !== "";
                const isConfirmPasswordFilled = confirmPassword.value.trim() !== "";

                if (password.value === confirmPassword.value) {
                    error.classList.add("hidden");
                } else {
                    error.classList.remove("hidden");
                }

                submitBtn.disabled = !(isUsernameFilled && isPasswordFilled && isConfirmPasswordFilled && password.value === confirmPassword.value);
            }

            function sendEmailConfirm() {
                submitBtn.addEventListener("click", async function () {
                    const username = document.getElementById("username").value.trim();
                    const newPassword = document.getElementById("password").value.trim();

                    const payload = {
                        username: username,
                        newPassword: newPassword
                    };
                    try {
                        fetch("http://localhost:8080/api/accounts/confirm-reset", {
                            method: "POST",
                            headers: {
                                "Content-Type": "application/json"
                            },
                            body: JSON.stringify(payload)
                        }).then(async response => {
                            if (response.ok) {
                                const result = await response.json();
                                if (result) {
                                    Swal.fire({
                                        icon: "success",
                                        title: "Email Sent",
                                        text: "We have sent an email to your account's email. Please check your mailbox to reset your password.",
                                    });
                                } else {
                                    Swal.fire({
                                        icon: "error",
                                        title: "Failed to Send Email",
                                        text: "An error occurred while sending the email. Please try again.",
                                    });
                                }
                            } else {
                                Swal.fire({
                                    icon: "error",
                                    title: "Request Failed",
                                    text: "Unable to process the request. Please try again later.",
                                });
                            }
                        }).catch(error => console.error(error))

                    } catch (error) {
                        console.error("Error:", error);
                    }
                });
            }
        });
    })();
</script>
</html>